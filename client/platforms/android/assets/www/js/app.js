// Generated by CoffeeScript 1.10.0
var BEACON_NEAR, PAID, c, countd, doPollPay, doPollPayThrott, nearCb, nearCbThrott, paidCb, pollPay;

c = console;

BEACON_NEAR = false;

PAID = false;

countd = function() {
  var time;
  time = Number($("span.timer").html());
  time -= 1;
  $("span.timer").html(time);
  if (time < 0) {
    return $(".timed_message").hide();
  } else {
    return setTimeout(countd, 1000);
  }
};

nearCb = function() {
  $(".idle").hide();
  $(".near").show();
  return pollPay();
};

nearCbThrott = _.throttle(nearCb, 500);

paidCb = function() {
  $(".near").hide();
  $(".bought").show();
  return countd();
};

doPollPay = function() {
  return $.getJSON("http://" + SERVER_HOST + ":3000/payment_status", function(resp) {
    c.log("payment_status", resp);
    if (resp.success && resp.status === "paid") {
      c.log("PAY");
      PAID = true;
      paidCb();
    }
    if (!PAID) {
      return pollPay();
    }
  });
};

doPollPayThrott = _.throttle(doPollPay, 800);

pollPay = function() {
  return _.delay(doPollPayThrott, 1000);
};

$("body").on("beacon_near", (function(_this) {
  return function(evt) {
    if (!BEACON_NEAR) {
      c.log("BEACON NEAR: " + BEACON_NEAR);
      nearCbThrott();
    }
    return BEACON_NEAR = true;
  };
})(this));

$(function() {
  $(".idle").show();
  if (PAID) {
    $(".near").show();
    return $(".bought").hide();
  }
});
